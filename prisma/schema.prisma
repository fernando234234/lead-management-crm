generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String         @id @default(cuid())
  username           String         @unique // Primary login identifier
  email              String?        @unique // Optional, kept for legacy/external integrations
  name               String
  password           String
  role               UserRole       @default(COMMERCIAL)
  mustChangePassword Boolean        @default(false)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  createdCampaigns   Campaign[]     @relation("CampaignCreator")
  createdLeads       Lead[]         @relation("CreatedBy")
  assignedLeads      Lead[]         @relation("AssignedTo")
  contactedLeads     Lead[]         @relation("ContactedBy")
  activities         LeadActivity[]
  notifications      Notification[]
  tasks              Task[]
  goals              Goal[]
}

model Course {
  id          String           @id @default(cuid())
  name        String
  description String?
  price       Decimal          @db.Decimal(10, 2)
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  campaigns   MasterCampaign[]
  legacyCampaigns Campaign[]
  leads       Lead[]
}

model Lead {
  id              String       @id @default(cuid())
  name            String
  email           String?
  phone           String?
  courseId        String
  notes           String?
  
  // Binary Statuses (Default: No/False)
  contacted       Boolean      @default(false)
  contactedAt     DateTime?
  contactedById   String?
  
  isTarget        Boolean      @default(false)
  targetNote      String?
  
  enrolled        Boolean      @default(false)
  enrolledAt      DateTime?
  
  // Relations
  campaignId      String?
  assignedToId    String?
  createdById     String?
  
  // Metrics
  acquisitionCost Decimal?     @db.Decimal(10, 2)
  revenue         Decimal?     @db.Decimal(10, 2)
  source          LeadSource   @default(MANUAL)
  status          LeadStatus   @default(NUOVO) // Legacy/Migration compatibility
  
  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  // Metadata
  appointmentDate  DateTime?
  appointmentNotes String?
  callOutcome      CallOutcome?
  outcomeNotes     String?

  // Relations
  assignedTo       User?          @relation("AssignedTo", fields: [assignedToId], references: [id])
  campaign         Campaign?      @relation(fields: [campaignId], references: [id])
  contactedBy      User?          @relation("ContactedBy", fields: [contactedById], references: [id])
  course           Course         @relation(fields: [courseId], references: [id])
  createdBy        User?          @relation("CreatedBy", fields: [createdById], references: [id])
  activities       LeadActivity[]
  tasks            Task[]

  @@index([courseId])
  @@index([campaignId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([source])
}

model MasterCampaign {
  id          String     @id @default(cuid())
  name        String     // e.g. "Summer Excel Sale"
  courseId    String
  status      String     @default("ACTIVE") // ACTIVE, ARCHIVED
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  course      Course     @relation(fields: [courseId], references: [id])
  campaigns   Campaign[] // Platform variants (Meta, Google, etc)
}

model Campaign {
  id               String          @id @default(cuid())
  masterCampaignId String?
  name             String          // e.g. "Meta - Summer Excel"
  platform         Platform
  budget           Decimal         @default(0) @db.Decimal(10, 2)
  status           CampaignStatus  @default(ACTIVE)
  startDate        DateTime        @default(now())
  endDate          DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdById      String
  
  masterCampaign   MasterCampaign? @relation(fields: [masterCampaignId], references: [id])
  createdBy        User            @relation("CampaignCreator", fields: [createdById], references: [id])
  spendRecords     CampaignSpend[]
  leads            Lead[]
  
  // Legacy fields kept optional for migration if needed, but we're shifting to MasterCampaign
  courseId         String? 
  course           Course?         @relation(fields: [courseId], references: [id])

  @@index([platform])
  @@index([masterCampaignId])
  @@index([createdById])
  @@index([status])
}

model CampaignSpend {
  id         String   @id @default(cuid())
  campaignId String
  date       DateTime @db.Date
  amount     Decimal  @db.Decimal(10, 2)
  notes      String?
  createdAt  DateTime @default(now())
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, date])
  @@index([date])
  @@index([campaignId])
}

model ProfitabilityRecord {
  id                String    @id @default(cuid())
  month             Int
  year              Int
  courseId          String?
  campaignId        String?
  commercialId      String?
  platform          Platform?
  revenue           Decimal   @default(0) @db.Decimal(10, 2)
  totalExpense      Decimal   @default(0) @db.Decimal(10, 2)
  costPerLead       Decimal   @default(0) @db.Decimal(10, 2)
  costPerConsulenza Decimal   @default(0) @db.Decimal(10, 2)
  costPerContract   Decimal   @default(0) @db.Decimal(10, 2)
  totalLeads        Int       @default(0)
  totalContacted    Int       @default(0)
  totalEnrolled     Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([month, year, courseId, campaignId, commercialId, platform])
  @@index([month, year])
  @@index([platform])
}

model LeadActivity {
  id          String       @id @default(cuid())
  leadId      String
  userId      String
  type        ActivityType
  description String
  metadata    Json?
  createdAt   DateTime     @default(now())
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([createdAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model Task {
  id          String       @id @default(cuid())
  userId      String
  leadId      String?
  title       String
  description String?
  dueDate     DateTime
  completed   Boolean      @default(false)
  completedAt DateTime?
  priority    TaskPriority @default(MEDIUM)
  createdAt   DateTime     @default(now())
  lead        Lead?        @relation(fields: [leadId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([dueDate])
  @@index([completed])
}

model Goal {
  id             String   @id @default(cuid())
  userId         String
  month          Int
  year           Int
  targetLeads    Int      @default(0)
  targetEnrolled Int      @default(0)
  targetCalls    Int      @default(0)
  targetRevenue  Decimal  @default(0) @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([month, year])
}

enum UserRole {
  ADMIN
  COMMERCIAL
  MARKETING
}

enum LeadStatus {
  NUOVO
  CONTATTATO
  IN_TRATTATIVA
  ISCRITTO
  PERSO
}

enum CallOutcome {
  POSITIVO
  NEGATIVO
  RICHIAMARE
  NON_RISPONDE
}

enum Platform {
  META          // Facebook + Instagram
  GOOGLE_ADS
  LINKEDIN
  TIKTOK
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

enum ActivityType {
  NOTE
  CALL
  EMAIL
  STATUS_CHANGE
  ASSIGNMENT
  ENROLLMENT
  LEAD_CREATED
  CONTACT
}

enum NotificationType {
  LEAD_ASSIGNED
  LEAD_STATUS_CHANGED
  LEAD_ENROLLED
  CAMPAIGN_CREATED
  REMINDER
  SYSTEM
  LEAD_CREATED
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum LeadSource {
  LEGACY_IMPORT
  MANUAL
  CAMPAIGN
}
