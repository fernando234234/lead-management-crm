generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Campaign {
  id               String          @id @default(cuid())
  masterCampaignId String?
  name             String
  platform         Platform
  budget           Decimal         @default(0) @db.Decimal(10, 2)
  status           CampaignStatus  @default(ACTIVE)
  startDate        DateTime        @default(now())
  endDate          DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdById      String
  courseId         String?
  course           Course?         @relation(fields: [courseId], references: [id])
  createdBy        User            @relation(fields: [createdById], references: [id])
  masterCampaign   MasterCampaign? @relation(fields: [masterCampaignId], references: [id])
  spendRecords     CampaignSpend[]
  leads            Lead[]

  @@index([createdById])
  @@index([masterCampaignId])
  @@index([platform])
  @@index([status])
}

model CampaignSpend {
  id         String    @id @default(cuid())
  campaignId String
  startDate  DateTime  @db.Date
  amount     Decimal   @db.Decimal(10, 2)
  notes      String?
  createdAt  DateTime  @default(now())
  endDate    DateTime? @db.Date
  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, startDate])
  @@index([campaignId])
  @@index([endDate])
  @@index([startDate])
}

model Course {
  id              String           @id @default(cuid())
  name            String
  description     String?
  price           Decimal          @db.Decimal(10, 2)
  startDate       DateTime?
  endDate         DateTime?
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  campaigns       Campaign[]
  leads           Lead[]
  masterCampaigns MasterCampaign[]
}

model Goal {
  id             String   @id @default(cuid())
  userId         String
  month          Int
  year           Int
  targetLeads    Int      @default(0)
  targetEnrolled Int      @default(0)
  targetCalls    Int      @default(0)
  targetRevenue  Decimal  @default(0) @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([month, year])
  @@index([userId])
}

model Lead {
  id                String         @id @default(cuid())
  name              String
  email             String?
  phone             String?
  courseId          String
  notes             String?
  contacted         Boolean        @default(false)
  contactedAt       DateTime?
  contactedById     String?
  isTarget          Boolean        @default(false)
  targetNote        String?
  enrolled          Boolean        @default(false)
  enrolledAt        DateTime?
  campaignId        String?
  assignedToId      String?
  createdById       String?
  acquisitionCost   Decimal?       @db.Decimal(10, 2)
  revenue           Decimal?       @db.Decimal(10, 2)
  source            LeadSource     @default(MANUAL)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  appointmentDate   DateTime?
  appointmentNotes  String?
  callOutcome       CallOutcome?
  outcomeNotes      String?
  callAttempts      Int            @default(0)
  firstAttemptAt    DateTime?
  lastAttemptAt     DateTime?
  status            LeadStatus     @default(NUOVO)
  assignedTo        User?          @relation("AssignedTo", fields: [assignedToId], references: [id])
  campaign          Campaign?      @relation(fields: [campaignId], references: [id])
  contactedBy       User?          @relation("ContactedBy", fields: [contactedById], references: [id])
  course            Course         @relation(fields: [courseId], references: [id])
  createdBy         User?          @relation("CreatedBy", fields: [createdById], references: [id])
  activities        LeadActivity[]
  tasks             Task[]

  @@index([assignedToId])
  @@index([campaignId])
  @@index([courseId])
  @@index([createdById])
  @@index([source])
}

model LeadActivity {
  id          String       @id @default(cuid())
  leadId      String
  userId      String
  type        ActivityType
  description String
  metadata    Json?
  createdAt   DateTime     @default(now())
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([leadId])
  @@index([userId])
}

model MasterCampaign {
  id        String     @id @default(cuid())
  name      String
  courseId  String
  status    String     @default("ACTIVE")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  campaigns Campaign[]
  course    Course     @relation(fields: [courseId], references: [id])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([read])
  @@index([userId])
}

model ProfitabilityRecord {
  id                String    @id @default(cuid())
  month             Int
  year              Int
  courseId          String?
  campaignId        String?
  commercialId      String?
  platform          Platform?
  revenue           Decimal   @default(0) @db.Decimal(10, 2)
  totalExpense      Decimal   @default(0) @db.Decimal(10, 2)
  costPerLead       Decimal   @default(0) @db.Decimal(10, 2)
  costPerConsulenza Decimal   @default(0) @db.Decimal(10, 2)
  costPerContract   Decimal   @default(0) @db.Decimal(10, 2)
  totalLeads        Int       @default(0)
  totalContacted    Int       @default(0)
  totalEnrolled     Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([month, year, courseId, campaignId, commercialId, platform])
  @@index([month, year])
  @@index([platform])
}

model Task {
  id          String       @id @default(cuid())
  userId      String
  leadId      String?
  title       String
  description String?
  dueDate     DateTime
  completed   Boolean      @default(false)
  completedAt DateTime?
  priority    TaskPriority @default(MEDIUM)
  createdAt   DateTime     @default(now())
  lead        Lead?        @relation(fields: [leadId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([completed])
  @@index([dueDate])
  @@index([leadId])
  @@index([userId])
}

model User {
  id                 String         @id @default(cuid())
  email              String?        @unique
  name               String
  password           String
  role               UserRole       @default(COMMERCIAL)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  mustChangePassword Boolean        @default(false)
  username           String         @unique
  createdCampaigns   Campaign[]
  goals              Goal[]
  assignedLeads      Lead[]         @relation("AssignedTo")
  contactedLeads     Lead[]         @relation("ContactedBy")
  createdLeads       Lead[]         @relation("CreatedBy")
  activities         LeadActivity[]
  notifications      Notification[]
  tasks              Task[]
}

enum ActivityType {
  NOTE
  CALL
  EMAIL
  STATUS_CHANGE
  ASSIGNMENT
  ENROLLMENT
  LEAD_CREATED
  CONTACT
}

enum CallOutcome {
  POSITIVO
  NEGATIVO
  RICHIAMARE
  NON_RISPONDE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

enum LeadSource {
  LEGACY_IMPORT
  MANUAL
  CAMPAIGN
}

enum LeadStatus {
  NUOVO
  CONTATTATO
  IN_TRATTATIVA
  ISCRITTO
  PERSO
}

enum NotificationType {
  LEAD_ASSIGNED
  LEAD_STATUS_CHANGED
  LEAD_ENROLLED
  CAMPAIGN_CREATED
  REMINDER
  SYSTEM
  LEAD_CREATED
}

enum Platform {
  META
  GOOGLE_ADS
  LINKEDIN
  TIKTOK
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum UserRole {
  ADMIN
  COMMERCIAL
  MARKETING
}
